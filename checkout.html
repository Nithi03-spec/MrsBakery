<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checkout - Mrs Bakery</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="bg">
    <header>
      <nav>
        <a href="cart.html">Cart</a>
        <a href="menu.html">Menu</a>
        <a href="tel:+919944061931">Call</a>
      </nav>
    </header>
    <hr />

    <section id="checkout">
      <h3>Checkout</h3>
      <p>Your order has been confirmed. Please choose a method to proceed:</p>

      <div class="payment-options">
        <button id="whatsappBtn" class="whatsapp-btn">Place Order via WhatsApp</button>
      </div>
    </section>
  </div>

  <!-- Firebase SDKs (Compat version) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyC6PcvJvG2w98RCJPhFoSwx9p-dQd8nTq8",
      authDomain: "mrsbakery-1a8a3.firebaseapp.com",
      databaseURL: "https://mrsbakery-1a8a3-default-rtdb.firebaseio.com",
      projectId: "mrsbakery-1a8a3",
      storageBucket: "mrsbakery-1a8a3.appspot.com",
      messagingSenderId: "701128267254",
      appId: "1:701128267254:web:fcd30c5bd6ec45bd27e3d7",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Save order to Firebase
    function saveOrder() {
      const cart = JSON.parse(localStorage.getItem("cart")) || [];

      if (cart.length === 0) {
        alert("Your cart is empty!");
        return false;
      }

      const timestamp = new Date().toISOString();

      return db.ref("orders")
        .push({
          cart: cart,
          total: cart.reduce((sum, item) => sum + item.price * item.quantity, 0),
          createdAt: timestamp,
        })
        .then(() => {
          console.log("Order saved to Firebase.");
          return true;
        })
        .catch((error) => {
          console.error("Error saving order:", error);
          alert("Error placing order. Please try again.");
          return false;
        });
    }

    // Generate WhatsApp order message
    function generateWhatsAppMessage(cart) {
      let message = "Hi, I would like to place an order:\n\n";
      cart.forEach(item => {
        message += `• ${item.name} x${item.quantity} - ₹${item.price * item.quantity}\n`;
      });

      const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
      message += `\nTotal: ₹${total}`;
      return encodeURIComponent(message);
    }

    // WhatsApp button handler
    document.getElementById("whatsappBtn").addEventListener("click", async function () {
      const cart = JSON.parse(localStorage.getItem("cart")) || [];

      if (cart.length === 0) {
        alert("Your cart is empty!");
        return;
      }

      const success = await saveOrder();
      if (success) {
        const encodedMessage = generateWhatsAppMessage(cart);
        const whatsappNumber = "919944061931";
        const waUrl = `https://wa.me/${whatsappNumber}?text=${encodedMessage}`;

        // Optionally clear cart after placing order
        localStorage.removeItem("cart");

        window.open(waUrl, "_blank");
      }
    });
  </script>
</body>
</html>
